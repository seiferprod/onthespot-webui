<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>OnTheSpot - Search</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link rel="icon" href="{{ url_for('static', filename='favicon.ico') }}" type="image/x-icon">
    <script src="{{ url_for('static', filename='utils.js') }}" defer></script>
    <style>
        /* ============= MOBILE-SPECIFIC OVERRIDES ============= */
        
        /* Container */
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 16px;
        }

        /* Search section */
        .search-section {
            background: linear-gradient(135deg, rgba(29, 185, 84, 0.15) 0%, rgba(29, 185, 84, 0.05) 100%);
            border: 1px solid rgba(29, 185, 84, 0.3);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 16px;
        }

        .auto-redirect-control {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 12px;
            padding: 10px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 8px;
            font-size: 13px;
            color: #ccc;
        }

        .auto-redirect-control input[type="checkbox"] {
            width: 16px;
            height: 16px;
            accent-color: var(--accent);
            cursor: pointer;
        }

        .auto-redirect-control label {
            cursor: pointer;
            user-select: none;
        }

        .search-form {
            display: flex;
            gap: 12px;
            align-items: stretch;
        }

        .search-input-wrapper {
            flex: 1;
            position: relative;
        }

        .search-input-wrapper input {
            width: 100%;
            padding: 14px 16px;
            padding-left: 44px;
            font-size: 15px;
            border-radius: 12px;
            border: 2px solid rgba(255, 255, 255, 0.1);
            background: rgba(0, 0, 0, 0.3);
            color: white;
            transition: all 0.2s ease;
        }

        .search-input-wrapper input:focus {
            border-color: var(--accent);
            outline: none;
            background: rgba(0, 0, 0, 0.4);
        }

        .search-input-wrapper input::placeholder {
            color: #888;
        }

        .search-icon {
            position: absolute;
            left: 14px;
            top: 50%;
            transform: translateY(-50%);
            width: 20px;
            height: 20px;
            opacity: 0.5;
            pointer-events: none;
        }

        .search-form button[type="submit"] {
            padding: 14px 24px;
            font-size: 14px;
            font-weight: 600;
            margin: 0;
            white-space: nowrap;
        }

        .filter-toggle-btn {
            padding: 14px;
            margin: 0;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .filter-toggle-btn:hover {
            background: rgba(255, 255, 255, 0.15);
        }

        .filter-toggle-btn img {
            width: 18px;
            height: 18px;
            filter: brightness(0) invert(0.8);
        }

        /* Filters panel */
        .filters-panel {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 16px;
            display: none;
        }

        .filters-panel.visible {
            display: block;
            animation: slideDown 0.25s ease;
        }

        @keyframes slideDown {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .filters-title {
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: #888;
            margin-bottom: 12px;
            font-weight: 600;
        }

        .filters-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 10px;
            margin-bottom: 12px;
        }

        .filter-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 12px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            transition: background 0.2s ease;
            cursor: pointer;
        }

        .filter-item:hover {
            background: rgba(255, 255, 255, 0.08);
        }

        .filter-item label {
            font-size: 13px;
            color: #ccc;
            cursor: pointer;
            flex: 1;
        }

        .filter-item input[type="checkbox"] {
            width: 18px;
            height: 18px;
            accent-color: var(--accent);
            cursor: pointer;
        }

        /* Table wrapper */
        .table-wrapper {
            background: rgba(255, 255, 255, 0.02);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            overflow: hidden;
        }

        .table-scroll {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }

        table {
            width: 100%;
            border-collapse: collapse; /* ensure row borders render cleanly */
        }

        th, td {
            padding: 12px 10px;
            font-size: 13px;
            /* remove the per-cell bottom border so we can draw one full-width
               separator per row (prevents misaligned fragments in the action col) */
            border-bottom: none;
        }

        /* Render a full-width separator on rows instead of per-cell borders */
        table tbody tr {
            border-bottom: 1px solid rgba(255,255,255,0.06);
        }

        /* Remove trailing separator on the last row */
        table tbody tr:last-child {
            border-bottom: none;
        }

        .type-column {
            white-space: nowrap;
        }

        /* Result item styling */
        .item-thumbnail {
            border-radius: 6px;
            object-fit: cover;
        }

        .item-name {
            font-weight: 500;
            max-width: 200px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .item-by {
            color: #aaa;
            max-width: 150px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        /* Type column alignment */
        th.type-column,
        td.type-column {
            text-align: right;
        }

        @media screen and (max-width: 600px) {
            /* Keep only thumbnail, name, and type visible and sized cleanly */
            table thead th.hide-on-mobile,
            table tbody td.hide-on-mobile,
            table thead th.action-header,
            table tbody td.action-cell-td {
                display: none !important;
            }

            /* Grid layout per row: thumbnail | name | type */
            table tbody tr {
                display: grid;
                grid-template-columns: 56px 1fr auto;
                align-items: center;
                column-gap: 8px; /* tighten spacing so badge sits closer */
                padding: 8px 8px;
                border-bottom: 1px solid rgba(255,255,255,0.06);
            }

            /* Hide the table header on mobile to avoid the heavy dark band */
            table thead {
                display: none !important;
            }

            /* Match header to the body grid */
            table thead tr {
                display: grid;
                grid-template-columns: 56px 1fr auto;
                align-items: center;
                column-gap: 10px;
                padding: 10px 8px;
                width: 100%;
                box-sizing: border-box;
            }

            /* Reset cell padding to work with the grid and avoid per-cell borders
               creating disjointed separators. We'll draw a single border on each
               row so it spans the full width. */
            th, td {
                padding: 0;
                border-bottom: none; /* prevent fragmented cell bottoms */
            }

            /* Remove trailing row separator */
            table tbody tr:last-child {
                border-bottom: none;
            }

            .item-thumbnail {
                width: 56px !important;
                height: 56px !important;
                min-width: 56px;
                border-radius: 8px;
                object-fit: cover;
                display: block;     /* avoid baseline alignment issues */
                align-self: center; /* ensure vertical centering */
            }

            .item-name {
                max-width: none;
                min-width: 0;
                overflow: hidden;
                text-overflow: ellipsis;
                white-space: nowrap;
            }

            th.type-column,
            td.type-column {
                text-align: right;
                justify-self: end;
            }

            td.type-column .type-badge {
                margin-left: 6px;
                float: none;
                display: inline-block;
            }
        }

        /* Type badges */
        .type-badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }

        .type-track {
            background: rgba(59, 130, 246, 0.2);
            color: #60a5fa;
        }

        .type-album {
            background: rgba(168, 85, 247, 0.2);
            color: #c084fc;
        }

        .type-playlist {
            background: rgba(34, 197, 94, 0.2);
            color: #4ade80;
        }

        .type-artist {
            background: rgba(251, 191, 36, 0.2);
            color: #fbbf24;
        }

        .type-episode, .type-podcast {
            background: rgba(236, 72, 153, 0.2);
            color: #f472b6;
        }

        .type-audiobook {
            background: rgba(249, 115, 22, 0.2);
            color: #fb923c;
        }

        /* Service icon */
        .service-cell {
            white-space: nowrap;
        }

        .service-cell img {
            border-radius: 4px;
            vertical-align: middle;
            margin-right: 6px;
        }

        .service-cell span {
            vertical-align: middle;
        }

        /* Action button group inside the action column */
        /* center the buttons inside the cell horizontally and vertically */
        .action-group {
            display: inline-flex;
            gap: 8px;
            flex-wrap: nowrap;
            align-items: center;    /* center vertically */
            justify-content: center; /* center horizontally within its TD */
        }

        /* Ensure the table cell (TD) that contains the action-group centers its
           child horizontally and vertically. Using text-align keeps the inner
           inline-flex group centered without converting the TD itself to flex. */
        td.action-cell-td {
            text-align: center;
            vertical-align: middle;
        }

        /* Hide action button cell on small screens */
        @media screen and (max-width: 600px) {
            .action-group,
            th.action-header,
            td.action-cell-td {
                display: none !important;
            }
            .type-badge {
                cursor: pointer;
                box-shadow: 0 2px 8px rgba(59,130,246,0.08);
                border: 1px solid rgba(59,130,246,0.12);
                transition: background 0.18s, box-shadow 0.18s;
            }
            .type-badge:hover {
                background: rgba(59,130,246,0.12);
                box-shadow: 0 4px 16px rgba(59,130,246,0.16);
            }
        }

        .action-group .download-action-button {
            padding: 6px;
            min-width: 32px;
            min-height: 32px;
            display: inline-flex; /* ensure icon centers inside */
            align-items: center;
            justify-content: center;
        }

        /* Empty state */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #666;
        }

        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 16px;
            opacity: 0.5;
        }

        .empty-state h3 {
            margin: 0 0 8px;
            color: #888;
        }

        .empty-state p {
            margin: 0;
            font-size: 14px;
        }

        /* Loading state */
        .loading-state {
            text-align: center;
            padding: 40px 20px;
        }

        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 3px solid rgba(255, 255, 255, 0.1);
            border-top-color: var(--accent);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 16px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Toast notification styles now in global style.css */

        /* Image preview popup */
        .image-preview-popup {
            position: fixed;
            z-index: 10000;
            opacity: 0;
            pointer-events: none;
            background: rgba(0, 0, 0, 0.95);
            border: 2px solid rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            padding: 8px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.8);
            transition: all 0.35s cubic-bezier(0.34, 1.56, 0.64, 1);
            transform-origin: top left;
            cursor: pointer;
        }

        .image-preview-popup.visible {
            opacity: 1;
            pointer-events: auto;
        }

        .image-preview-popup img {
            display: block;
            max-width: 80vw;
            max-height: 80vh;
            min-width: 300px;
            min-height: 300px;
            width: auto;
            height: auto;
            border-radius: 8px;
        }

        .item-thumbnail {
            cursor: pointer;
            transition: transform 0.2s ease;
        }

        .item-thumbnail:hover {
            transform: scale(1.05);
        }

        /* Title popup */
        .title-popup {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0.9);
            z-index: 10001;
            opacity: 0;
            pointer-events: none;
            background: rgba(0, 0, 0, 0.95);
            border: 2px solid rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            padding: 20px;
            max-width: 80vw;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.8);
            transition: all 0.25s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        .title-popup.visible {
            opacity: 1;
            pointer-events: auto;
            transform: translate(-50%, -50%) scale(1);
        }

        .title-popup-content {
            color: white;
            font-size: 16px;
            font-weight: 500;
            text-align: center;
            word-wrap: break-word;
        }

        /* ============= RESPONSIVE BREAKPOINTS ============= */
        @media screen and (max-width: 768px) {
            .search-section {
                padding: 16px;
            }

            .search-form {
                flex-direction: column;
            }

            .search-form button[type="submit"] {
                width: 100%;
            }

            .search-row {
                display: flex;
                gap: 8px;
            }

            .search-row .search-input-wrapper {
                flex: 1;
            }

            .filters-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            th, td {
                padding: 10px 8px;
                font-size: 12px;
            }

            .hide-on-mobile {
                display: none !important;
            }

            .item-name {
                max-width: calc(100% - 120px);
                min-width: 0;
            }

            /* Compact type badge on mobile */
            .type-badge {
                padding: 2px 7px;
                font-size: 9px;
            }

            /* Compact action buttons */
            .action-group {
                gap: 2px;
            }

            .action-group .download-action-button {
                padding: 5px;
                min-width: 28px;
                min-height: 28px;
            }

            .action-group .download-action-button img {
                width: 14px;
                height: 14px;
            }

            .toast {
                left: 16px;
                right: 16px;
                transform: translateX(0) translateY(100px);
                bottom: calc(16px + env(safe-area-inset-bottom));
            }

            .toast.visible {
                transform: translateX(0) translateY(0);
            }

            .image-preview-popup img {
                max-width: 70vw;
                max-height: 70vh;
                min-width: 250px;
                min-height: 250px;
            }
        }

        @media screen and (max-width: 480px) {
            .container {
                padding: 12px;
            }

            .search-section {
                padding: 12px;
            }

            .filters-grid {
                grid-template-columns: 1fr 1fr;
                gap: 8px;
            }

            .filter-item {
                padding: 8px 10px;
            }

            .filter-item label {
                font-size: 12px;
            }

            th, td {
                padding: 8px 6px;
                font-size: 11px;
            }

            .item-name {
                max-width: none;
                min-width: 0;
            }

            .image-preview-popup img {
                max-width: 85vw;
                max-height: 85vh;
                min-width: 200px;
                min-height: 200px;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <ul>
            <li><a class="active" href="/search">Search</a></li>
            <li><a href="/download_queue">Downloads</a></li>
            <li><a href="/plex_playlists">Plex</a></li>
            {% if user and user.is_admin %}<li><a href="/settings">Settings</a></li>{% endif %}
            <li><a href="/about">About</a></li>
            <li style="float: right;"><a href="/api/logout" style="color: #e74c3c;">Logout</a></li>
        </ul>
    </div>

    <div class="container">
        <!-- Search Section -->
        <div class="search-section">
            <form class="search-form" onsubmit="submitSearch(event)">
                <div class="search-row" style="display: flex; gap: 8px; flex: 1;">
                    <div class="search-input-wrapper">
                        <svg class="search-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="11" cy="11" r="8"/>
                            <path d="m21 21-4.35-4.35"/>
                        </svg>
                        <input type="text" id="search-bar" name="q" placeholder="Search for music, podcasts, audiobooks..." autocomplete="off" autofocus>
                    </div>
                    <button type="button" class="filter-toggle-btn download-action-button" onclick="toggleFilters()" title="Toggle Filters">
                        <img id="collapse_button_icon" src="/icons/collapse_down.png" loading="lazy">
                    </button>
                </div>
                <button type="submit">Search</button>
            </form>
            <div class="auto-redirect-control">
                <input type="checkbox" id="auto-redirect-checkbox" checked>
                <label for="auto-redirect-checkbox">Show downloads screen after selection</label>
            </div>
        </div>

        <!-- Filters Panel -->
        <div id="filters-panel" class="filters-panel">
            <div class="filters-title">Search For</div>
            <div class="filters-grid">
                <div class="filter-item">
                    <input type="checkbox" id="enable_search_tracks">
                    <label for="enable_search_tracks">Tracks</label>
                </div>
                <div class="filter-item">
                    <input type="checkbox" id="enable_search_albums" checked>
                    <label for="enable_search_albums">Albums</label>
                </div>
                <div class="filter-item">
                    <input type="checkbox" id="enable_search_playlists">
                    <label for="enable_search_playlists">Playlists</label>
                </div>
                <div class="filter-item">
                    <input type="checkbox" id="enable_search_artists">
                    <label for="enable_search_artists">Artists</label>
                </div>
                <div class="filter-item">
                    <input type="checkbox" id="enable_search_episodes">
                    <label for="enable_search_episodes">Episodes</label>
                </div>
                <div class="filter-item">
                    <input type="checkbox" id="enable_search_podcasts">
                    <label for="enable_search_podcasts">Podcasts</label>
                </div>
                <div class="filter-item">
                    <input type="checkbox" id="enable_search_audiobooks">
                    <label for="enable_search_audiobooks">Audiobooks</label>
                </div>
            </div>
        </div>

        <!-- Results Table -->
        <div class="table-wrapper">
            <div class="table-scroll">
                <table id="results-table">
                    <thead>
                        <tr>
                            {% if config.show_search_thumbnails %}
                            <th></th>
                            {% endif %}
                            <th>Name</th>
                            <th class="hide-on-mobile">By</th>
                            <th class="type-column">Type</th>
                            <th class="hide-on-mobile">Service</th>
                            <th class="action-header">Action</th>
                        </tr>
                    </thead>
                    <tbody id="results-body">
                        <tr>
                            <td colspan="6">
                                <div class="empty-state">
                                    <div class="empty-state-icon">üîç</div>
                                    <h3>Search for music</h3>
                                    <p>Enter a song, artist, album, or playlist name above</p>
                                </div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Toast notification -->
    <div id="toast" class="toast">
        <span class="toast-icon"></span>
        <span class="toast-message"></span>
    </div>

    <!-- Image preview popup -->
    <div id="image-preview-popup" class="image-preview-popup">
        <img id="image-preview-img" src="" alt="Preview">
    </div>

    <!-- Title popup -->
    <div id="title-popup" class="title-popup">
        <div class="title-popup-content"></div>
    </div>

    <script>
        let filtersVisible = false;
        let isSearching = false;
        let imagePreviewVisible = false;

        // Detect if touch device
        const isTouchDevice = ('ontouchstart' in window) || (navigator.maxTouchPoints > 0);

        // ============= UI FUNCTIONS =============
        function toggleFilters() {
            const panel = document.getElementById('filters-panel');
            filtersVisible = !filtersVisible;
            
            if (filtersVisible) {
                panel.classList.add('visible');
            } else {
                panel.classList.remove('visible');
            }
        }

        // Keep original function name for compatibility
        function toggleVisibility() {
            toggleFilters();
        }

        // showToast function now in global utils.js

        // ============= IMAGE PREVIEW FUNCTIONS =============
        function getLargerImageUrl(thumbnailUrl) {
            // Try to get the highest quality version
            let largerUrl = thumbnailUrl;

            // For Spotify images, try to get the original unscaled version
            // Spotify pattern: Try removing size constraint or using ab67616d0000b273 (full size)
            if (largerUrl.includes('i.scdn.co/image/')) {
                // Try to use the full-size version by using the image hash without size prefix
                largerUrl = largerUrl.replace(/ab67616d[0-9a-f]{8}/, 'ab67616d0000b273');
            }

            // Also try larger explicit sizes as fallback
            largerUrl = largerUrl.replace(/\/(\d+)x(\d+)\//, '/640x640/');

            // Try to replace common thumbnail size indicators
            largerUrl = largerUrl.replace(/small|thumb|thumbnail|medium/gi, 'large');
            largerUrl = largerUrl.replace(/_small\.|_thumb\.|_thumbnail\.|_medium\./gi, '_large.');

            // If URL has size parameters, try to increase them
            largerUrl = largerUrl.replace(/([?&])(width|w|size)=\d+/gi, '$1$2=640');
            largerUrl = largerUrl.replace(/([?&])(height|h)=\d+/gi, '$1$2=640');

            return largerUrl;
        }

        function toggleImagePreview(imageUrl, thumbnailElement) {
            // Toggle behavior for touch devices
            if (imagePreviewVisible) {
                hideImagePreview();
            } else {
                showImagePreview(imageUrl, thumbnailElement);
            }
        }

        function showImagePreview(imageUrl, thumbnailElement) {
            const popup = document.getElementById('image-preview-popup');
            const img = document.getElementById('image-preview-img');

            // Get thumbnail position and size
            const rect = thumbnailElement.getBoundingClientRect();
            const thumbnailLeft = rect.left;
            const thumbnailTop = rect.top;
            const thumbnailWidth = rect.width;
            const thumbnailHeight = rect.height;

            // Try to get larger image URL
            const largerUrl = getLargerImageUrl(imageUrl);
            img.src = largerUrl;

            // Calculate target (center) position and size
            const targetLeft = window.innerWidth / 2;
            const targetTop = window.innerHeight / 2;

            // Start at thumbnail position with thumbnail size
            popup.style.left = thumbnailLeft + 'px';
            popup.style.top = thumbnailTop + 'px';
            popup.style.width = thumbnailWidth + 'px';
            popup.style.height = thumbnailHeight + 'px';
            popup.style.transform = 'translate(0, 0) scale(1)';

            // Force reflow
            popup.offsetHeight;

            // Add visible class for opacity transition
            popup.classList.add('visible');
            imagePreviewVisible = true;

            // Animate to center with larger size
            // Use setTimeout to ensure the transition applies
            setTimeout(() => {
                popup.style.left = targetLeft + 'px';
                popup.style.top = targetTop + 'px';
                popup.style.width = 'auto';
                popup.style.height = 'auto';
                popup.style.transform = 'translate(-50%, -50%) scale(1)';
            }, 10);
        }

        function hideImagePreview() {
            const popup = document.getElementById('image-preview-popup');
            popup.classList.remove('visible');
            imagePreviewVisible = false;
        }

        // ============= TITLE POPUP FUNCTIONS =============
        let titlePopupVisible = false;

        function toggleTitlePopup(title) {
            if (titlePopupVisible) {
                hideTitlePopup();
            } else {
                showTitlePopup(title);
            }
        }

        function showTitlePopup(title) {
            const popup = document.getElementById('title-popup');
            const content = popup.querySelector('.title-popup-content');
            content.textContent = title;
            popup.classList.add('visible');
            titlePopupVisible = true;

            // Auto-hide after 3 seconds on touch devices
            if (isTouchDevice) {
                setTimeout(() => {
                    if (titlePopupVisible) {
                        hideTitlePopup();
                    }
                }, 3000);
            }
        }

        function hideTitlePopup() {
            const popup = document.getElementById('title-popup');
            popup.classList.remove('visible');
            titlePopupVisible = false;
        }

        function showLoading() {
            const tableBody = document.getElementById('results-body');
            tableBody.innerHTML = `
                <tr>
                    <td colspan="6">
                        <div class="loading-state">
                            <div class="loading-spinner"></div>
                            <p>Searching...</p>
                        </div>
                    </td>
                </tr>
            `;
        }

        function showEmpty() {
            const tableBody = document.getElementById('results-body');
            tableBody.innerHTML = `
                <tr>
                    <td colspan="6">
                        <div class="empty-state">
                            <div class="empty-state-icon">üîç</div>
                            <h3>No results found</h3>
                            <p>Try a different search term</p>
                        </div>
                    </td>
                </tr>
            `;
        }

        // ============= FILTER FUNCTIONS =============
        function returnSearchFilters() {
            return {
                enable_search_tracks: document.getElementById('enable_search_tracks').checked,
                enable_search_albums: document.getElementById('enable_search_albums').checked,
                enable_search_artists: document.getElementById('enable_search_artists').checked,
                enable_search_playlists: document.getElementById('enable_search_playlists').checked,
                enable_search_episodes: document.getElementById('enable_search_episodes').checked,
                enable_search_podcasts: document.getElementById('enable_search_podcasts').checked,
                enable_search_audiobooks: document.getElementById('enable_search_audiobooks').checked,
            };
        }

        // ============= TYPE BADGE =============
        function createTypeBadge(type, url) {
            const typeClasses = {
                'track': 'type-track',
                'album': 'type-album',
                'playlist': 'type-playlist',
                'artist': 'type-artist',
                'episode': 'type-episode',
                'podcast': 'type-podcast',
                'audiobook': 'type-audiobook'
            };
            const className = typeClasses[type?.toLowerCase()] || '';
            // On mobile, make badge clickable for download
            if (window.innerWidth <= 600) {
                return `<span class="type-badge ${className}" onclick="handleDownload('${url}')">${capitalizeFirstLetter(type)}</span>`;
            }
            return `<span class="type-badge ${className}">${capitalizeFirstLetter(type)}</span>`;
        }

        // ============= SEARCH FUNCTIONS =============
        function submitSearch(event) {
            event.preventDefault();

            if (isSearching) return;

            const query = document.getElementById('search-bar').value.trim();
            if (!query) return;

            isSearching = true;
            showLoading();

            // Build URL with filter parameters
            const filters = returnSearchFilters();
            const params = new URLSearchParams({
                q: query,
                tracks: filters.enable_search_tracks,
                albums: filters.enable_search_albums,
                playlists: filters.enable_search_playlists,
                artists: filters.enable_search_artists,
                episodes: filters.enable_search_episodes,
                podcasts: filters.enable_search_podcasts,
                audiobooks: filters.enable_search_audiobooks
            });

            // Save search state to localStorage
            localStorage.setItem('lastSearchQuery', query);
            localStorage.setItem('lastSearchFilters', JSON.stringify(filters));

            fetch(`/api/search_results?${params}`)
                .then(response => response.json())
                .then(data => {
                    isSearching = false;

                    // Handle new response format with success field
                    if (data.success === false) {
                        showEmpty();
                        showToast(data.message || 'Search failed', 'error');
                        return;
                    }

                    // Handle URL parsing success message
                    if (data.success === true && data.message && data.results.length === 0) {
                        showEmpty();
                        showToast(data.message, 'success');
                        return;
                    }

                    // Render search results
                    const results = data.results || data;
                    renderResults(results);

                    // Cache the search results
                    localStorage.setItem('lastSearchResults', JSON.stringify(results));
                })
                .catch(error => {
                    isSearching = false;
                    console.error('Search error:', error);
                    showEmpty();
                    showToast('Search failed. Please try again.', 'error');
                });
        }

        function renderResults(data) {
            const tableBody = document.getElementById('results-body');
            tableBody.innerHTML = '';

            if (!data || data.length === 0) {
                showEmpty();
                return;
            }
            
            const showThumbnails = {{ config.show_search_thumbnails|tojson }};
            const thumbnailSize = {{ config.thumbnail_size }};
            
            data.forEach(item => {
                const row = document.createElement('tr');
                
                // Thumbnail (visible on mobile too)
                if (showThumbnails) {
                    const imgCell = document.createElement('td');
                    if (item.item_thumbnail_url) {
                        const img = document.createElement('img');
                        img.src = item.item_thumbnail_url;
                        img.className = 'item-thumbnail';
                        img.loading = 'lazy';
                        img.style.width = `${thumbnailSize}px`;
                        img.style.height = `${thumbnailSize}px`;

                        // Add event listeners for image preview
                        if (isTouchDevice) {
                            // On touch devices, use click to toggle
                            img.addEventListener('click', (e) => {
                                e.preventDefault();
                                toggleImagePreview(item.item_thumbnail_url, img);
                            });
                        } else {
                            // On desktop, use hover
                            img.addEventListener('mouseenter', () => showImagePreview(item.item_thumbnail_url, img));
                            img.addEventListener('mouseleave', hideImagePreview);
                        }

                        imgCell.appendChild(img);
                    }
                    row.appendChild(imgCell);
                }
                
                // Name
                const nameCell = document.createElement('td');
                nameCell.className = 'item-name';
                nameCell.textContent = item.item_name;
                nameCell.title = item.item_name;

                // Add click listener for touch devices to show full title
                if (isTouchDevice) {
                    nameCell.style.cursor = 'pointer';
                    nameCell.addEventListener('click', () => {
                        toggleTitlePopup(item.item_name);
                    });
                }

                row.appendChild(nameCell);
                
                // By
                const byCell = document.createElement('td');
                byCell.className = 'hide-on-mobile item-by';
                byCell.textContent = item.item_by || '';
                byCell.title = item.item_by || '';
                row.appendChild(byCell);
                
                // Type
                const typeCell = document.createElement('td');
                typeCell.className = 'type-column';
                typeCell.innerHTML = createTypeBadge(item.item_type, item.item_url);
                row.appendChild(typeCell);
                
                // Service (icon and text inline)
                const serviceCell = document.createElement('td');
                serviceCell.className = 'service-cell hide-on-mobile';
                if (item.item_service) {
                    serviceCell.innerHTML = `<img src="/icons/${item.item_service}.png" loading="lazy" style="width: 20px; height: 20px;"><span>${formatServiceName(item.item_service)}</span>`;
                }
                row.appendChild(serviceCell);
                
                // Actions
                const actionCell = document.createElement('td');
                actionCell.className = 'action-cell-td';
                const linkButton = createButton('icons/link.png', 'Open Link', `window.open('${item.item_url}', '_blank')`);
                const downloadButton = createButton('icons/download.png', 'Download', `handleDownload('${item.item_url}')`);
                actionCell.innerHTML = `<div class="action-group">${linkButton}${downloadButton}</div>`;
                row.appendChild(actionCell);
                
                tableBody.appendChild(row);
            });
        }

        function handleDownload(url) {
            showToast('Starting download...', 'success');

            fetch(`/api/parse_url/${encodeURIComponent(url)}`, {
                method: 'POST',
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showToast('Download started!', 'success');

                    // Check if auto-redirect is enabled
                    const autoRedirect = document.getElementById('auto-redirect-checkbox').checked;
                    if (autoRedirect) {
                        setTimeout(() => {
                            window.location.href = '/download_queue';
                        }, 1000);
                    }
                } else {
                    showToast('Download failed: ' + (data.error || 'Unknown error'), 'error');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showToast('Error starting download', 'error');
            });
        }

        // ============= INITIALIZATION =============
        document.addEventListener('DOMContentLoaded', () => {
            // Add click handler to image preview to dismiss it
            const imagePopup = document.getElementById('image-preview-popup');
            imagePopup.addEventListener('click', () => {
                if (imagePreviewVisible) {
                    hideImagePreview();
                }
            });

            // Close popups when clicking outside on touch devices
            if (isTouchDevice) {
                document.addEventListener('click', (e) => {
                    const imagePopup = document.getElementById('image-preview-popup');
                    const titlePopup = document.getElementById('title-popup');

                    // Close image preview if clicking outside
                    if (imagePreviewVisible && !imagePopup.contains(e.target) && !e.target.classList.contains('item-thumbnail')) {
                        hideImagePreview();
                    }

                    // Close title popup if clicking outside
                    if (titlePopupVisible && !titlePopup.contains(e.target) && !e.target.classList.contains('item-name')) {
                        hideTitlePopup();
                    }
                });
            }

            // Restore last search state from localStorage
            const lastSearchQuery = localStorage.getItem('lastSearchQuery');
            const lastSearchFilters = localStorage.getItem('lastSearchFilters');

            if (lastSearchFilters) {
                try {
                    const filters = JSON.parse(lastSearchFilters);
                    // Restore checkbox states
                    document.getElementById('enable_search_tracks').checked = filters.enable_search_tracks;
                    document.getElementById('enable_search_albums').checked = filters.enable_search_albums;
                    document.getElementById('enable_search_playlists').checked = filters.enable_search_playlists;
                    document.getElementById('enable_search_artists').checked = filters.enable_search_artists;
                    document.getElementById('enable_search_episodes').checked = filters.enable_search_episodes;
                    document.getElementById('enable_search_podcasts').checked = filters.enable_search_podcasts;
                    document.getElementById('enable_search_audiobooks').checked = filters.enable_search_audiobooks;
                } catch (e) {
                    console.error('Error restoring filters:', e);
                }
            }

            if (lastSearchQuery) {
                // Restore search query
                const searchBar = document.getElementById('search-bar');
                searchBar.value = lastSearchQuery;

                // Try to load cached results first
                const cachedResults = localStorage.getItem('lastSearchResults');
                if (cachedResults) {
                    try {
                        const results = JSON.parse(cachedResults);
                        renderResults(results);
                    } catch (e) {
                        console.error('Error loading cached results:', e);
                        // Fall back to fetching new results
                        submitSearch(new Event('submit'));
                    }
                } else {
                    // No cached results, fetch new ones
                    submitSearch(new Event('submit'));
                }

                // Select the text so user can start typing immediately
                searchBar.select();
            } else {
                // Focus search input only if no previous search
                document.getElementById('search-bar').focus();
            }

            // Handle Enter key in search
            document.getElementById('search-bar').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    submitSearch(e);
                }
            });

            // Add event listeners to filter checkboxes to auto-trigger search
            const filterCheckboxes = [
                'enable_search_tracks',
                'enable_search_albums',
                'enable_search_playlists',
                'enable_search_artists',
                'enable_search_episodes',
                'enable_search_podcasts',
                'enable_search_audiobooks'
            ];

            filterCheckboxes.forEach(id => {
                document.getElementById(id).addEventListener('change', () => {
                    const query = document.getElementById('search-bar').value.trim();
                    // Only auto-search if there's a query and we're not already searching
                    if (query && !isSearching) {
                        submitSearch(new Event('submit'));
                    }
                });
            });

            // Load auto-redirect preference from localStorage
            const autoRedirectCheckbox = document.getElementById('auto-redirect-checkbox');
            const savedPreference = localStorage.getItem('autoRedirectToDownloads');
            if (savedPreference !== null) {
                autoRedirectCheckbox.checked = savedPreference === 'true';
            }

            // Save preference when checkbox changes
            autoRedirectCheckbox.addEventListener('change', (e) => {
                localStorage.setItem('autoRedirectToDownloads', e.target.checked);
            });
        });
    </script>
</body>
</html>
